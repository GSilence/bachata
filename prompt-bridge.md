# Задача: Реализация "Умного анализа ритма" (Madmom + Bridge Detection)

**Контекст:**
У нас есть проект "Bachata Beat Counter" (Next.js, Prisma, Howler.js). См. `SYSTEM_OVERVIEW.md`.
Мы отказываемся от простых алгоритмов в пользу профессиональной библиотеки `madmom` для анализа ритма.

**Цель:**
Научить систему находить не только BPM, но и "Мостики" (вставки по 4 счета, сбивающие сетку), используя нейросети.

**Твои задачи:**

### ШАГ 1. Подготовка окружения (Python)

Обнови инструкции или `requirements.txt`. Нам нужны:

- `madmom` (для RNNDownBeatProcessor)
- `numpy`
- `scipy` (для обработки сигнала)

### ШАГ 2. Скрипт анализа (`scripts/analyze-track.py`)

Напиши новый мощный скрипт на Python. Он должен заменить старый `analyze-bpm-offset.py`.

**Логика работы скрипта:**

1.  **Загрузка:** Принимает путь к MP3.
2.  **Downbeat Tracking (Madmom):**
    Используй `madmom.features.beats.RNNDownBeatProcessor` и `DBNBeatTrackingProcessor`.
    Нам нужно получить массив ударов, где каждый удар имеет метку: "1" (сильная доля), "2", "3", "4".
3.  **Детекция Мостиков (Алгоритм "Mikhail's Logic"):**
    - Пройдись по найденным сильным долям ("Единицам").
    - Обычно расстояние между ними = 8 битов (или 4 такта).
    - **Аномалия:** Если расстояние между "Единицами" сократилось до 4 битов.
    - **Проверка (Bridge vs Break):**
      - Рассчитай RMS (энергию/громкость) на этом коротком участке.
      - Если есть резкий пик громкости (громче среднего по треку) -> Это Брейк (игнорируем).
      - Если громкость "ровная" (flat) -> **Это Мостик!**
4.  **Вывод JSON:**
    Скрипт должен вернуть JSON структуру:
    ```json
    {
      "bpm": 128,
      "offset": 0.45,
      "grid": [
        { "type": "verse", "start": 0.0, "beats": 32 },
        { "type": "bridge", "start": 15.4, "beats": 4 },
        { "type": "verse", "start": 17.2, "beats": 32 }
      ]
    }
    ```

### ШАГ 3. База данных (Prisma)

Обнови `prisma/schema.prisma`.
В модель `Track`:

- Добавь поле `gridMap Json?` (для хранения сложной структуры, которую вернет скрипт).
- Поля `bpm` и `offset` оставь как "базовые" значения (для фолбэка).

### ШАГ 4. Логика плеера (`lib/audioEngine.ts`)

Это критически важно. Текущая логика линейна (`time * bpm`).
Перепиши метод отслеживания бита (`updateBeat`):

1.  Плеер должен смотреть в `track.gridMap`.
2.  Определять, в какой секции мы находимся (Verse или Bridge).
3.  Если мы внутри Мостика -> считать 1-2-3-4.
4.  Если Мостик закончился -> сбрасывать счетчик на "1" (Grid Reset).

**Требования:**

- Не сломай существующее воспроизведение MP3 и стемов.
- Код должен быть чистым и типизированным.
