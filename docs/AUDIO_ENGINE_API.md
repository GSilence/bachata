# AudioEngine API Документация

Полное описание всех методов класса `AudioEngine` - ядра системы воспроизведения аудио и отслеживания битов для Bachata Beat Counter.

## Содержание

- [Обзор](#обзор)
- [Публичные методы](#публичные-методы)
- [Приватные методы](#приватные-методы)
- [Свойства и состояние](#свойства-и-состояние)
- [Примеры использования](#примеры-использования)

---

## Обзор

`AudioEngine` - это singleton класс, который управляет:
- Воспроизведением аудио (цельный файл или стемы)
- Отслеживанием битов и счетом (1-8)
- Синхронизацией с музыкальными секциями (verse/bridge)
- Воспроизведением голосового счета

### Получение экземпляра

```typescript
import { audioEngine } from '@/lib/audioEngine';

// audioEngine - уже созданный singleton экземпляр
```

---

## Публичные методы

### `getInstance(): AudioEngine`

**Статический метод** для получения singleton экземпляра AudioEngine.

**Возвращает:** `AudioEngine` - единственный экземпляр класса

**Пример:**
```typescript
const engine = AudioEngine.getInstance();
```

---

### `loadTrack(track, isStemsMode?, stemsEnabled?, stemsVolume?)`

Загружает трек в движок для воспроизведения.

**Параметры:**
- `track: Track` - объект трека с метаданными (обязательно)
- `isStemsMode?: boolean` - использовать ли режим стемов (опционально)
- `stemsEnabled?: { vocals, drums, bass, other }` - какие стемы включены (опционально)
- `stemsVolume?: { vocals, drums, bass, other }` - громкость каждого стема 0-100 (опционально)

**Возвращает:** `void`

**Что делает:**
1. Останавливает текущий трек и выгружает его
2. Применяет настройки стемов (если переданы)
3. Строит beat grid из `track.beatGrid` или генерирует fallback
4. Загружает аудио:
   - Если `isStemsMode && track.isProcessed` → загружает 4 стема
   - Иначе → загружает цельный файл из `track.pathOriginal`

**Пример:**
```typescript
audioEngine.loadTrack(track, true, {
  vocals: true,
  drums: true,
  bass: false,
  other: true
}, {
  vocals: 100,
  drums: 80,
  bass: 0,
  other: 60
});
```

---

### `play()`

Начинает воспроизведение текущего загруженного трека.

**Возвращает:** `void`

**Что делает:**
1. Устанавливает флаг `_isPlaying = true`
2. Запускает воспроизведение Howl инстансов (музыка или стемы)
3. Синхронизирует курсор битов с текущим временем
4. Воспроизводит голосовой счет для текущего бита (если нужно)
5. Запускает цикл обновления (`startUpdate()`)

**Пример:**
```typescript
audioEngine.play();
```

---

### `pause()`

Приостанавливает воспроизведение.

**Возвращает:** `void`

**Что делает:**
1. Устанавливает флаг `_isPlaying = false`
2. Приостанавливает все Howl инстансы
3. Останавливает цикл обновления

**Пример:**
```typescript
audioEngine.pause();
```

---

### `stop()`

Полностью останавливает воспроизведение и сбрасывает позицию на 0.

**Возвращает:** `void`

**Что делает:**
1. Устанавливает флаг `_isPlaying = false`
2. Останавливает все Howl инстансы
3. Сбрасывает позицию на 0 (`seek(0)`)
4. Сбрасывает индекс текущего бита на 0
5. Останавливает цикл обновления
6. Уведомляет UI о сбросе времени на 0

**Пример:**
```typescript
audioEngine.stop();
```

---

### `isPlaying(): boolean`

Проверяет, играет ли трек в данный момент.

**Возвращает:** `boolean` - `true` если трек играет, `false` если на паузе/остановлен

**Примечание:** Возвращает значение внутреннего флага `_isPlaying`, а не состояние Howler. Это предотвращает "мигание" UI при старте.

**Пример:**
```typescript
if (audioEngine.isPlaying()) {
  console.log('Трек играет');
}
```

---

### `getCurrentTime(): number`

Получает текущую позицию воспроизведения в секундах.

**Возвращает:** `number` - текущее время в секундах (0 если трек не загружен)

**Логика:**
- В режиме стемов: возвращает время из `vocals` стема (или другого доступного)
- В обычном режиме: возвращает время из `musicTrack`

**Пример:**
```typescript
const currentTime = audioEngine.getCurrentTime();
console.log(`Текущая позиция: ${currentTime.toFixed(2)}s`);
```

---

### `getDuration(): number`

Получает общую длительность трека в секундах.

**Возвращает:** `number` - длительность в секундах (0 если трек не загружен)

**Логика:**
- В режиме стемов: возвращает длительность из `vocals` стема
- В обычном режиме: возвращает длительность из `musicTrack`

**Пример:**
```typescript
const duration = audioEngine.getDuration();
console.log(`Длительность трека: ${duration.toFixed(2)}s`);
```

---

### `isTrackLoaded(): boolean`

Проверяет, загружен ли трек и готов ли к воспроизведению.

**Возвращает:** `boolean` - `true` если трек загружен, `false` если нет

**Логика:**
- Если нет `currentTrack` → возвращает `false`
- В режиме стемов: проверяет наличие всех 4 стемов
- В обычном режиме: проверяет наличие `musicTrack`

**Пример:**
```typescript
if (audioEngine.isTrackLoaded()) {
  audioEngine.play();
} else {
  console.log('Трек еще не загружен');
}
```

---

### `seek(time: number)`

Перемещает позицию воспроизведения на указанное время.

**Параметры:**
- `time: number` - новое время в секундах

**Возвращает:** `void`

**Что делает:**
1. Проверяет, что трек загружен (`getDuration() > 0`)
2. Ограничивает время в пределах [0, duration]
3. Останавливает цикл обновления
4. Устанавливает новую позицию для всех Howl инстансов
5. Синхронизирует курсор битов с новой позицией
6. Воспроизводит голосовой счет для бита на новой позиции (если нужно)
7. Уведомляет UI о новом времени
8. Если трек играл до seek → возобновляет цикл обновления

**Пример:**
```typescript
// Перейти на 30 секунду
audioEngine.seek(30);
```

---

### `setMusicVolume(volume: number)`

Устанавливает общую громкость музыки.

**Параметры:**
- `volume: number` - громкость от 0 до 100

**Возвращает:** `void`

**Что делает:**
1. Сохраняет значение в `this.musicVolume`
2. Применяет громкость через `applyVolume()`

**Пример:**
```typescript
audioEngine.setMusicVolume(75); // 75% громкости
```

---

### `setStemsVolume(stems: Partial<{vocals, drums, bass, other}>)`

Устанавливает громкость отдельных стемов.

**Параметры:**
- `stems: Partial<{vocals: number, drums: number, bass: number, other: number}>` - объект с громкостями 0-100

**Возвращает:** `void`

**Примечание:** Можно передать только нужные стемы, остальные не изменятся.

**Пример:**
```typescript
// Увеличить громкость вокала и уменьшить ударные
audioEngine.setStemsVolume({
  vocals: 120, // > 100 для усиления
  drums: 50
});
```

---

### `setStemsEnabled(stems: Partial<{vocals, drums, bass, other}>)`

Включает/выключает отдельные стемы.

**Параметры:**
- `stems: Partial<{vocals: boolean, drums: boolean, bass: boolean, other: boolean}>` - объект с флагами включения

**Возвращает:** `void`

**Что делает:**
1. Обновляет `this.stemsEnabled`
2. Применяет изменения через `applyVolume()` (выключенные стемы получают громкость 0)

**Пример:**
```typescript
// Выключить бас и остальное
audioEngine.setStemsEnabled({
  bass: false,
  other: false
});
```

---

### `setStemsMode(enabled: boolean)`

Переключает между режимом стемов и цельным файлом.

**Параметры:**
- `enabled: boolean` - `true` для режима стемов, `false` для цельного файла

**Возвращает:** `void`

**Что делает:**
1. Если режим не изменился → выходит
2. Сохраняет текущую позицию и состояние воспроизведения
3. Перезагружает трек в новом режиме
4. Восстанавливает позицию и состояние через 150ms

**Пример:**
```typescript
// Переключиться на стемы
audioEngine.setStemsMode(true);

// Вернуться к цельному файлу
audioEngine.setStemsMode(false);
```

---

### `setVoiceVolume(volume: number)`

Устанавливает громкость голосового счета.

**Параметры:**
- `volume: number` - громкость от 0 до 100

**Возвращает:** `void`

**Что делает:**
1. Ограничивает значение в пределах [0, 100]
2. Применяет громкость ко всем загруженным голосовым файлам (1.mp3 - 8.mp3)

**Пример:**
```typescript
audioEngine.setVoiceVolume(50); // 50% громкости голоса
```

---

### `setOnTrackEnd(callback: (() => void) | null)`

Устанавливает callback, который вызывается когда трек заканчивается.

**Параметры:**
- `callback: (() => void) | null` - функция-обработчик или `null` для удаления

**Возвращает:** `void`

**Пример:**
```typescript
audioEngine.setOnTrackEnd(() => {
  console.log('Трек закончился!');
  // Автоматически переключить на следующий трек
  playNext();
});
```

---

### `setOnTimeUpdate(callback: ((time: number) => void) | null)`

Устанавливает callback для получения текущего времени воспроизведения.

**Параметры:**
- `callback: ((time: number) => void) | null` - функция, получающая текущее время в секундах, или `null` для удаления

**Возвращает:** `void`

**Примечание:** Вызывается в цикле обновления (~60 раз в секунду) для синхронизации UI.

**Пример:**
```typescript
audioEngine.setOnTimeUpdate((time) => {
  // Обновить прогресс-бар
  updateProgressBar(time);
});
```

---

### `getCurrentBeatIndex(): number`

Получает индекс текущего бита в beat grid.

**Возвращает:** `number` - индекс бита в массиве `beatGrid`, или `-1` если нет битов

**Пример:**
```typescript
const beatIndex = audioEngine.getCurrentBeatIndex();
if (beatIndex >= 0) {
  const currentBeat = beatGrid[beatIndex];
  console.log(`Текущий бит: ${currentBeat.number}`);
}
```

---

### `unloadTrack()`

Выгружает текущий трек из памяти.

**Возвращает:** `void`

**Что делает:**
1. Останавливает цикл обновления
2. Останавливает и выгружает все Howl инстансы (музыка и стемы)
3. Вызывает `Howler.unload()` для глобальной очистки
4. Сбрасывает все внутренние состояния:
   - `currentTrack = null`
   - `beatMap = []`
   - `beatGrid = []`
   - `currentBeatIndex = 0`

**Пример:**
```typescript
audioEngine.unloadTrack();
```

---

### `destroy()`

Полностью уничтожает экземпляр AudioEngine.

**Возвращает:** `void`

**Что делает:**
1. Останавливает воспроизведение
2. Выгружает трек
3. Удаляет все callbacks

**Примечание:** Обычно не нужно вызывать вручную, так как AudioEngine - singleton.

**Пример:**
```typescript
audioEngine.destroy();
```

---

## Приватные методы

### `preloadVoiceFiles()`

Предзагружает все голосовые файлы (1.mp3 - 8.mp3) при создании экземпляра.

**Вызывается:** Автоматически в конструкторе

---

### `loadFullFile(track: Track)`

Загружает цельный аудио файл.

**Параметры:**
- `track: Track` - трек с `pathOriginal`

**Что делает:**
- Создает новый Howl инстанс для `track.pathOriginal`
- Настраивает громкость и обработчики событий

---

### `loadStems(track: Track)`

Загружает 4 стема (vocals, drums, bass, other).

**Параметры:**
- `track: Track` - трек с путями к стемам

**Что делает:**
- Проверяет наличие всех путей к стемам
- Если не хватает → fallback на `loadFullFile()`
- Создает 4 Howl инстанса с индивидуальными настройками громкости
- Настраивает обработчик окончания на `vocals` стеме

---

### `handleTrackEnd()`

Обрабатывает окончание трека.

**Что делает:**
1. Устанавливает `_isPlaying = false`
2. Останавливает цикл обновления
3. Вызывает `onTrackEnd` callback (если установлен и еще не вызван)

---

### `buildBeatMap(track: Track)`

Строит массив времен битов из gridMap или генерирует fallback.

**Параметры:**
- `track: Track` - трек с `gridMap` или `bpm`/`offset`

**Что делает:**
- Если есть `gridMap` → строит биты из секций
- Иначе → генерирует равномерные биты по BPM и offset

---

### `applyVolume()`

Применяет текущие настройки громкости ко всем Howl инстансам.

**Что делает:**
- В режиме стемов: вычисляет финальную громкость для каждого стема как `musicVolume * stemVolume * (enabled ? 1 : 0)`
- В обычном режиме: применяет `musicVolume` к `musicTrack`

---

### `syncBeatCursor(time: number): number`

Синхронизирует индекс текущего бита с указанным временем.

**Параметры:**
- `time: number` - время для синхронизации

**Возвращает:** `number` - индекс бита, который должен играть на этом времени, или `-1`

**Что делает:**
- Находит ближайший бит к указанному времени
- Обновляет `currentBeatIndex`
- Возвращает индекс, если бит должен играть "очень скоро" (в пределах 0.1s)

---

### `update()`

Основной цикл обновления (вызывается через setInterval).

**Что делает:**
1. Получает текущее время
2. Уведомляет UI через `onTimeUpdate`
3. Проверяет секции для коррекции счетчика (каждые 0.5s)
4. Обрабатывает биты и воспроизводит голосовой счет
5. Продолжает цикл (setInterval уже запущен)

**Примечание:** Работает даже когда вкладка неактивна (использует setInterval вместо requestAnimationFrame)

---

### `checkAndCorrectSectionAlignment(currentTime: number)`

Проверяет и корректирует счетчик на границах секций (verse/bridge).

**Параметры:**
- `currentTime: number` - текущее время воспроизведения

**Что делает:**
1. Проверяет каждую секцию из `gridMap`
2. Игнорирует микро-секции (короче 4 beats)
3. Если находимся в начале секции и счетчик показывает не "1" → корректирует на "1"
4. Обновляет номера битов в секции (1-8)

**Примечание:** Это ключевая функция для "неубиваемого" счетчика, который сам исправляет ошибки.

---

### `playVoiceCount(beatNumber: number)`

Воспроизводит голосовой файл для указанного бита.

**Параметры:**
- `beatNumber: number` - номер бита (1-8)

**Что делает:**
- Останавливает предыдущий голосовой файл
- Воспроизводит соответствующий файл (`/audio/voice/{beatNumber}.mp3`)

---

### `startUpdate()`

Запускает цикл обновления.

**Что делает:**
1. Проверяет, не запущен ли уже цикл
2. Определяет интервал обновления:
   - Активная вкладка: 16ms (~60fps)
   - Неактивная вкладка: 50ms (экономия ресурсов)
3. Запускает `setInterval(() => this.update(), interval)`
4. Настраивает обработчик `visibilitychange` для адаптации частоты

---

### `stopUpdate()`

Останавливает цикл обновления.

**Что делает:**
1. Очищает `setInterval`
2. Отменяет `requestAnimationFrame` (если был)
3. Удаляет обработчик `visibilitychange`

---

## Свойства и состояние

### Публичные свойства

Нет. Все свойства приватные для инкапсуляции.

### Внутреннее состояние

- `musicTrack: Howl | null` - основной трек (цельный файл)
- `stemsTracks: {vocals, drums, bass, other}` - 4 стема
- `currentTrack: Track | null` - текущий загруженный трек
- `_isPlaying: boolean` - флаг воспроизведения
- `beatGrid: Beat[]` - массив битов с временами и номерами
- `currentBeatIndex: number` - индекс текущего бита
- `voiceFiles: Map<number, Howl>` - загруженные голосовые файлы

---

## Примеры использования

### Базовое воспроизведение

```typescript
// Загрузить трек
audioEngine.loadTrack(track);

// Начать воспроизведение
audioEngine.play();

// Приостановить
audioEngine.pause();

// Остановить
audioEngine.stop();
```

### Работа со стемами

```typescript
// Загрузить трек в режиме стемов
audioEngine.loadTrack(track, true);

// Настроить громкость стемов
audioEngine.setStemsVolume({
  vocals: 100,
  drums: 80,
  bass: 60,
  other: 40
});

// Выключить бас
audioEngine.setStemsEnabled({
  bass: false
});
```

### Отслеживание прогресса

```typescript
// Установить callback для обновления UI
audioEngine.setOnTimeUpdate((time) => {
  const duration = audioEngine.getDuration();
  const progress = (time / duration) * 100;
  updateProgressBar(progress);
});
```

### Автопереключение треков

```typescript
audioEngine.setOnTrackEnd(() => {
  // Переключить на следующий трек
  const nextTrack = getNextTrack();
  audioEngine.loadTrack(nextTrack);
  audioEngine.play();
});
```

### Переключение режимов

```typescript
// Переключиться на стемы (сохраняя позицию)
audioEngine.setStemsMode(true);

// Вернуться к цельному файлу
audioEngine.setStemsMode(false);
```

---

## Примечания

1. **Singleton паттерн**: AudioEngine использует singleton, поэтому всегда один экземпляр на приложение.

2. **Работа в фоне**: Цикл обновления использует `setInterval` вместо `requestAnimationFrame` для работы даже когда вкладка неактивна.

3. **Синхронизация счетчика**: Автоматическая коррекция счетчика на границах секций обеспечивает точность даже при небольших рассинхронизациях.

4. **Громкость стемов**: Финальная громкость стема = `musicVolume * stemVolume * (enabled ? 1 : 0)`.

5. **Beat Grid**: Используется для точного отслеживания битов. Если не предоставлен в треке, генерируется fallback на основе BPM и offset.

---

## Версия

Документация актуальна для версии: **2024**

