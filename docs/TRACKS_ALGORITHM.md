# Алгоритм работы с треками

## Как треки попадают на страницу

### Текущий алгоритм:

1. **Источник данных: База данных MySQL**
   - Треки НЕ сканируются автоматически из папки `public/music/`
   - Все треки хранятся в таблице `Track` в БД
   - При загрузке страницы выполняется запрос `GET /api/tracks`
   - API возвращает все записи из таблицы `Track`, отсортированные по дате создания (новые сверху)

2. **Структура данных в БД:**
   ```prisma
   model Track {
     id          Int      @id @default(autoincrement())
     title       String   // Название трека
     artist      String?  // Исполнитель (опционально)
     filename    String   // Имя файла в /public/music/
     bpm         Int      // Темп (ударов в минуту)
     offset      Float    // Смещение первого бита (секунды)
     isFree      Boolean  @default(true)
     createdAt   DateTime @default(now())
   }
   ```

3. **Процесс отображения:**
   - `app/page.tsx` → `useEffect` → `fetch('/api/tracks')`
   - Данные сохраняются в Zustand store через `setTracks(data)`
   - Компонент `Playlist` отображает треки из store
   - При выборе трека он загружается в `AudioEngine`

### Проблема: Файлы в папке ≠ Треки в БД

**Важно:** Просто добавить файл в `public/music/` недостаточно! Нужно также добавить запись в БД.

## Решение: Скрипт сканирования папки

Создан скрипт `scripts/scan-music-folder.ts`, который:
1. Сканирует папку `public/music/`
2. Находит MP3 файлы, которых нет в БД
3. Автоматически добавляет их в БД с дефолтными значениями

### Использование:

```bash
npm run db:scan
```

### Что делает скрипт:

1. Читает все `.mp3` файлы из `public/music/`
2. Сравнивает с существующими записями в БД (по полю `filename`)
3. Для новых файлов:
   - Парсит название и артиста из имени файла
   - Убирает префикс номера (например, "02 ")
   - Создает запись в БД с:
     - `bpm: 120` (дефолт, нужно обновить вручную)
     - `offset: 0` (дефолт, нужно обновить вручную)
     - `isFree: true`

### Формат имени файла:

Скрипт пытается разобрать формат:
- `"Artist - Title.mp3"` → `artist: "Artist"`, `title: "Title"`
- `"02 Title - Artist.mp3"` → убирает "02 ", `title: "Title"`, `artist: "Artist"`
- `"Title.mp3"` → `title: "Title"`, `artist: null`

## Проверка состояния БД

Для проверки, что находится в БД:

```bash
npm run db:check
```

## Ручное добавление треков

Можно добавить треки вручную через:
1. Prisma Studio: `npm run db:studio`
2. SQL запросы напрямую в БД
3. Будущий админ-интерфейс `/admin/upload`

## Следующие шаги

1. ✅ Сканирование папки и автоматическое добавление
2. ✅ Админ-интерфейс для загрузки и обработки треков (Demucs)
3. ⏳ Автоматическое определение BPM и offset

